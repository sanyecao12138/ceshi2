<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="utf-8">
    <title>第五阶段</title>
    <link rel="stylesheet" href="https://js.arcgis.com/4.29/esri/css/main.css">
    <script src="https://js.arcgis.com/4.29/"></script>
    <style>
	
	
        html, body, #viewDiv {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
			}
		
		#modal {
		    display: none; /* Hidden by default */
		    position: fixed; /* Stay in place */
		    z-index: 100; /* Sit on top */
		    left: 0;
		    top: 0;
		    width: 100%; /* Full width */
		    height: 100%; /* Full height */
		    overflow: auto; /* Enable scroll if needed */
		    background-color: rgb(0,0,0); /* Fallback color */
		    background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
		    padding-top: 60px;
		}
		#modalContent {
		    background-color: #fefefe;
		    margin: 20% auto; /* 15% from the top and centered */
		    padding: 20px;
		    border: 1px solid #888;
		    width: 60%; /* Could be more or less, depending on screen size */
		}
		.close {
		    color: #aaa;
		    float: right;
		    font-size: 28px;
		    font-weight: bold;
		}
		.close:hover,
		.close:focus {
		    color: black;
		    text-decoration: none;
		    cursor: pointer;
		}
						

		.site-header {
		    position: fixed; /* 将元素的定位设为固定，意味着它会在滚动页面时保持在视口的相同位置。 */
		    top: 0; /* 将元素的顶部与视口的顶部对齐。 */
		    left: 0; /* 将元素的左边与视口的左边对齐。 */
		    width: 100%; /* 将元素的宽度设置为100%，使其占满整个视口的宽度。 */
		    background-color: #6A5ACD; /* 设置元素的背景颜色为紫色。 */
		    color: white; /* 设置元素内文本的颜色为白色。 */
		    text-align: center; /* 文本对齐方式设置为居中，使得元素内的文本居中显示。 */
		    font-size: 24px; /* 设置字体大小为24像素。 */
		    font-weight: bold; /* 设置字体的粗细为加粗。 */
		    z-index: 1000; /* 设置元素的堆叠顺序，一个较高的值意味着元素会被放置在其他较低z-index值的元素之上。 */
		    padding: 10px 0; /* 设置元素的内边距，20px是上下内边距，0是左右内边距。这样做是为了增加元素的可视高度，让倒梯形的效果更明显。 */
		
		    /* 使用clip-path属性定义一个自定义的剪裁路径，创建倒梯形的视觉效果。polygon函数定义了多边形的各个顶点。 */
		    clip-path: polygon(25% 0, 75% 0, 60% 100%, 40% 100%);
		    /*
		      polygon的参数解释：
		      - 0 0：第一个顶点在左上角，相对于元素的位置是0%宽度和0%高度。
		      - 100% 0：第二个顶点在右上角，相对于元素的位置是100%宽度和0%高度。
		      - 80% 100%：第三个顶点位于元素底部稍向内的位置，相对于元素的位置是80%宽度和100%高度。
		      - 20% 100%：第四个顶点也位于元素底部稍向内的位置，相对于元素的位置是20%宽度和100%高度。
		      
		      这些顶点连起来形成了一个倒梯形。
		    */
		}
		
				
				
		.action-buttons-container {
		    position: absolute; /* 维持绝对定位 */
		    top: 37%; /* 保持原有的垂直位置 */
		    left: 10px; /* 使用左对齐，替代之前的右对齐 */
		    display: flex; /* 维持flexbox布局 */
		    flex-direction: column; /* 继续竖直排列按钮 */
		    align-items: flex-start; /* 更新为左对齐 */
		}
		
		.action-buttons-container button {
		    margin-bottom: 5px; /* 按钮之间的垂直间距保持不变 */
			 background-color: white; /* 设置按钮背景色为白色 */
			    color: black; /* 设置按钮文字颜色为黑色，确保在白色背景上可读 */
				 border: 1px solid #ccc; /* 可选：添加边框以增强按钮在白色背景上的可见度 */
		}
		
		
	
		  
		  #attributesTable {   
		      position: fixed;
		      right: 10px; /* 将元素定位到屏幕的右侧 */
		      top: 65%; /* 开始于屏幕高度的一半 */
		      transform: translateY(-42%); /* 修改为-50%，以更准确地实现垂直居中 */
		      width: 300px; /* 可根据需要调整宽度 */
		      height: 450px; /* 设置为固定高度 */
		      overflow: auto; /* 内容超出时显示滚动条 */
		      background: white; /* 背景色 */
		      border-left: 2px solid #ccc; /* 左侧边框，可根据需要调整 */
		      box-shadow: -2px 0 5px rgba(0,0,0,0.3); /* 向左的阴影，增加立体感 */
			  z-index: 1; 
		  }
		  #attributesTable th, #attributesTable td {
		      border: 1px solid #ddd; /* 设置单元格的边框 */
		      text-align: left; /* 文本对齐方式 */
		      padding: 8px; /* 单元格内边距 */
		  }
		  
		  #attributesTable th {
		      background-color: #f2f2f2; /* 表头背景颜色，可根据喜好调整 */
		      color: black; /* 表头文字颜色 */
		  }
		  
		  
		  
		
		.filter-section {
		   bottom: 150px; /* 将top属性改为bottom，并设置合适的距离底部的值 */
		     left: 10px;
		     z-index: 2;
		     background: white;
		     padding: 10px;
		     position: fixed; /* 添加position属性，并将其设置为fixed，这样可以相对于浏览器窗口定位 */
		
		}
		
		
		  .filter-section .filter-title { /* 为“专题显示”标题添加样式 */
		            font-size: 16px;
		            font-weight: bold;
		            margin-bottom: 10px;
		        }
				
				
		.filter-section select {
		    margin-bottom: 5px;
		    display: block;
		}
		

    </style>
</head>
<body>
	<div class="site-header">
	    房屋信息采集系统
	</div>
	
    <div id="viewDiv"></div>
<!-- 	<div class="search-section">
	    <input type="text" id="searchInput" placeholder="搜索房屋...">
	    <button id="searchButton">搜索</button>
	</div> -->


 <div id="modal">
        <div id="modalContent">
            <span class="close">&times;</span>
            <p id="modalText">Some text in the Modal..</p>
        </div>
    </div>

<div id="attributesTable"></div>



      <div class="action-buttons-container">
            <button id="toggleBasemap">切换底图</button> 
            <button id="distanceButton">距离量算</button>
            <button id="areaButton">面积量算</button>
            <button id="clearMeasurement">清除测量</button>
            <button id="toggleEditor">要素编辑</button>
        <button id="exportButton">数据导出</button>
		<button id="statsButton">风险分类统计</button>
		<button id="toggleAttributesTable">显示/隐藏属性表</button>

		
		<div class="filter-section">
		 <div class="filter-title">专题显示</div> <!-- “专题显示”标题 -->
        <label for="riskLevel">风险等级:</label>
        <select id="riskLevel">
           <option value="">全部</option>
            <option value="wuweixian">无危险点</option>
            <option value="youweixian">有危险点</option>
            <option value="jubu">局部危险</option>
            <option value="zhengti">整体危险</option>
        </select>

        <label for="structureType">房屋结构:</label>
        <select id="structureType">
           <option value="">全部</option>
            <option value="zhuanmu">砖木结构</option>
            <option value="zhuanhun">砖混结构</option>
            <option value="gangjinhun">钢筋混凝土结构</option>
			<option value="gangjinhun">钢结构</option>
            <option value="qita">其他</option>
        </select>

        <label for="floorCount">房屋楼层:</label>
        <select id="floorCount">
           <option value="">全部</option>
            <option value="diceng">低层建筑</option>
            <option value="duoceng">多层建筑</option>
            <option value="zhonggao">中高层建筑</option>
            <option value="gaoceng">高层建筑</option>
        </select>
		
		
   </div>
	</div>

    <script>
        require([
			"esri/config",
            "esri/Map",
            "esri/views/MapView",
            "esri/widgets/Measurement",
            "esri/WebMap",
            "esri/widgets/Legend",
            "esri/widgets/Compass",
            "esri/widgets/ScaleBar",
            "esri/widgets/Locate",
            "esri/layers/FeatureLayer",
            "esri/widgets/Editor",
			"esri/widgets/Search",
			"esri/widgets/BasemapToggle",
			"esri/Basemap"
			
        ], function(esriConfig,Map, MapView, Measurement, WebMap, Legend, Compass, ScaleBar, Locate, FeatureLayer, Editor, Search, BasemapToggle, Basemap) {
			esriConfig.apiKey = "AAPKcff031ef4fa64291b01dccba2acd2acfGEviYTy9VV7QUV-YlyVGN0LWaabOlBhxCoCnW4iUz2K6FbgPVb9I89YLH8ciFUzx";

            var webmap = new WebMap({
                portalItem: {
                    id: "9ef84fb3c5dd4543a48749b082044802"
                }
            });

            var view = new MapView({
                container: "viewDiv",
                map: webmap
            });

            var featureLayer = new FeatureLayer({
				url: "https://services6.arcgis.com/W2Gimh0c3HZMSgA0/arcgis/rest/services/biyesheji/FeatureServer/0",
                // portalItem: {
                //     id: "9ff68877b0b94e17b25eb58341e973e0"
                // }
            });
            webmap.add(featureLayer);

            var editor = null;

            var measurement = new Measurement({
                view: view
            });

            var legend = new Legend({
                view: view,
                layerInfos: [
                    {
                        layer: featureLayer,
                        title: "房屋"
                    }
                ]
            });
			
			
			
			
			//  var basemapToggle = new BasemapToggle({
			//                 view: view,
			//                 nextBasemap: "satellite" // 或者使用自定义的底图
			//             });
			
			           
			
			//             // 切换底图的功能函数
			//             function toggleBasemap() {
			//                 if (view.map.basemap.id === "streets") {
			//                     view.map.basemap = "satellite";
			//                 } else {
			//                     view.map.basemap = "streets";
			//                 }
			//             }
			
			//             // 点击切换底图按钮时触发切换底图功能
			     
			
			view.when(function() {
			                var basemapToggle = new BasemapToggle({
			                    view: view,
			                    nextBasemap: "satellite"
			                });
			
			              
			
			                document.getElementById("toggleBasemap").addEventListener("click", function() {
			                    basemapToggle.toggle();
			                });
			            });
			
						
						
			
			var searchWidget = new Search({
			        view: view,
			        sources: [{
			            layer: featureLayer,
			            searchFields: ["fangwubianhao", "fangwucengshu", "fangwujiegou", "fengxiandengji"],
			            displayField: "fangwubianhao",
			            exactMatch: false,
			            outFields: ["*"],
			            name: "房屋搜索",
			            placeholder: "例：1001, 钢结构, 高层, 无危险"
			        }]
			    });
			
			    // 将搜索微件添加到视图中
			    view.ui.add(searchWidget, {
			        position: "top-right",
			        index: 2 // 确定搜索微件的位置
			    });
			
			function displayAllFeatures() {
			    var query = featureLayer.createQuery();
			    query.where = "1=1"; // 这个查询条件表示选择所有要素
			    // 仅查询需要的字段
			    query.outFields = ["*"];
			
			    featureLayer.queryFeatures(query).then(function(results) {
			        updateAttributesTable(results.features);
			    }).catch(function(error) {
			        console.error("查询发生错误: ", error);
			    });
			}
			
			
			
			function updateAttributesTable(features) {
			    var attributesTable = document.getElementById("attributesTable");
			    attributesTable.innerHTML = ""; // 清空现有的属性信息
			
			    // 定义字段值到标签的映射
			    var fengxiandengjiMapping = {
			        "wuweixian": "无危险",
			        "youweixian": "有危险",
			        "jubu": "局部危险",
			        "zhengti": "整体危险"
			    };
			    var fangwujiegouMapping = {
			        "zhuanmu": "砖木结构",
			        "zhuanhun": "砖混结构",
			        "gangjinhun": "钢筋混凝土结构",
			        "gang": "钢结构",
			        "qita": "其他结构"
			    };
			    var fangwucengshuMapping = {
			        "diceng": "低层",
			        "duoceng": "多层",
			        "zhonggao": "中高层",
			        "gaoceng": "高层"
			    };
			
			    if (features.length > 0) {
			        var table = document.createElement("table");
			        table.style.width = "100%";
					
					
					  // 创建并添加表格标题
					        var caption = document.createElement("caption");
					        caption.textContent = "房屋属性表";
					        caption.style.fontWeight = "bold"; // 可选：增加标题的字体粗细，使其更突出
					        caption.style.padding = "8px"; // 可选：增加标题的内边距
					        table.appendChild(caption);
					
			        var thead = document.createElement("thead");
			        var headerRow = document.createElement("tr");
			        var headers = ["房屋编号", "风险等级", "房屋结构", "房屋楼层"];
			        headers.forEach(function(header) {
			            var th = document.createElement("th");
			            th.textContent = header;
			            headerRow.appendChild(th);
			        });
			        thead.appendChild(headerRow);
			        table.appendChild(thead);
			
			        var tbody = document.createElement("tbody");
			        features.forEach(function(feature) {
			            var tr = document.createElement("tr");
			            var fields = ["fangwubianhao", "fengxiandengji", "fangwujiegou", "fangwucengshu"];
			            fields.forEach(function(field) {
			                var td = document.createElement("td");
			                // 使用映射转换字段值
			                var value = feature.attributes[field];
			                if (field === "fengxiandengji") {
			                    value = fengxiandengjiMapping[value] || value; // 如果映射不存在，则使用原始值
			                } else if (field === "fangwujiegou") {
			                    value = fangwujiegouMapping[value] || value;
			                } else if (field === "fangwucengshu") {
			                    value = fangwucengshuMapping[value] || value;
			                }
			                td.textContent = value;
			                tr.appendChild(td);
			            });
			            tbody.appendChild(tr);
			        });
			
			        table.appendChild(tbody);
			        attributesTable.appendChild(table);
			    } else {
			        attributesTable.textContent = "没有找到要素";
			    }
			}
			
			// 调用该函数来显示属性表
			displayAllFeatures();
			
			// 获取按钮和属性表元素
			var toggleButton = document.getElementById("toggleAttributesTable");
			var attributesTable = document.getElementById("attributesTable");
			
			// 初始时隐藏属性表
			attributesTable.style.display = "none";
			
			// 点击按钮时切换属性表的显示状态
			toggleButton.onclick = function() {
				
			    if (attributesTable.style.display === "none") {
			        attributesTable.style.display = "block";
			    } else {
			        attributesTable.style.display = "none";
			    }
			};
			
			
			
			
			
			
			
			
			
			// 要素导出
			 function exportFeatures() {
			                // 获取要素数据
			                featureLayer.queryFeatures().then(function(results) {
			                    var features = results.features;
			
			                    // 转换为导出的数据格式
			                    var exportData = features.map(function(feature) {
			                        return {
			                            fangwubianhao: feature.attributes.fangwubianhao,
			                            fengxiandengji: feature.attributes.fengxiandengji,
			                            fangwucengshu: feature.attributes.fangwucengshu,
			                            fangwujiegou: feature.attributes.fangwujiegou
			                        };
			                    });
			
			                    // 创建要素数据的 JSON 字符串
			                    var jsonFeatures = JSON.stringify(exportData);
			
			                    // 创建下载链接
			                    var element = document.createElement('a');
			                    element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(jsonFeatures));
			                    element.setAttribute('download', 'features.json');
			
			                    // 隐藏元素
			                    element.style.display = 'none';
			                    document.body.appendChild(element);
			
			                    // 触发点击下载
			                    element.click();
			
			                    // 移除元素
			                    document.body.removeChild(element);
			                });
			            }
			
			            // 添加按钮点击事件监听
			            document.getElementById('exportButton').addEventListener('click', exportFeatures);
			
			
			
			
			var modal = document.getElementById("modal");
			            var span = document.getElementsByClassName("close")[0];
			            var modalText = document.getElementById("modalText");
			
			            span.onclick = function() {
			                modal.style.display = "none";
			            }
			            window.onclick = function(event) {
			                if (event.target == modal) {
			                    modal.style.display = "none";
			                }
			            }
			
			            document.getElementById("statsButton").onclick = function() {
			                featureLayer.load().then(function() {
			                    var riskLevels = {
			                        "wuweixian": "无危险点",
			                        "youweixian": "有危险点",
			                        "jubu": "局部危险",
			                        "zhengti": "整体危险"
			                    };
			                    var statsResults = "风险等级统计结果:\n";
			
			                    var promises = Object.keys(riskLevels).map(function(level) {
			                        var query = featureLayer.createQuery();
			                        query.where = "fengxiandengji = '" + level + "'";
			                        return featureLayer.queryFeatures(query).then(function(results) {
			                            statsResults += riskLevels[level] + "的房屋数量:" + results.features.length + "\n\n";
										
			                        });
			                    });
			
			                    Promise.all(promises).then(function() {
			                        modalText.textContent = statsResults;
			                        modal.style.display = "block";
			                    }).catch(function(error) {
			                        console.error("查询错误: ", error);
			                        modalText.textContent = "查询错误: " + error;
			                        modal.style.display = "block";
			                    });
			                }).catch(function(error) {
			                    console.error("FeatureLayer加载错误: ", error);
			                    modalText.textContent = "FeatureLayer加载错误: " + error;
			                    modal.style.display = "block";
			                });
			            };
				
			

            document.getElementById("distanceButton").onclick = function() {
                measurement.activeTool = "distance";
                measurement.startMeasurement();
            };

            document.getElementById("areaButton").onclick = function() {
                measurement.activeTool = "area";
                measurement.startMeasurement();
            };

            document.getElementById("clearMeasurement").onclick = function() {
                measurement.clear();
            };

            document.getElementById("toggleEditor").onclick = function() {
                if (!editor) {
                    editor = new Editor({
                        view: view,
                        layerInfos: [{
                            layer: featureLayer,
                            title: "要素图层"
                        }]
                    });
                    view.ui.add(editor,  { position: "top-right", index: 1000 });
                    this.textContent = "关闭编辑";
                } else {
                    view.ui.remove(editor);
                    editor.destroy();
                    editor = null;
                    this.textContent = "要素编辑";
                }
            };




            // 添加筛选条件变更的事件监听
            document.getElementById("riskLevel").onchange = updateFilter;
            document.getElementById("structureType").onchange = updateFilter;
            document.getElementById("floorCount").onchange = updateFilter;
           //过滤器功能
			function updateFilter() {
                var riskLevel = document.getElementById("riskLevel").value;
                var structureType = document.getElementById("structureType").value;
                var floorCount = document.getElementById("floorCount").value;

                var expressions = [];
                if (riskLevel) expressions.push("fengxiandengji = '" + riskLevel + "'");
                if (structureType) expressions.push("fangwujiegou = '" + structureType + "'");
                if (floorCount) expressions.push("fangwucengshu = '" + floorCount + "'");

                var expression = expressions.join(" AND ");
                featureLayer.definitionExpression = expression;
            }
			view.ui.add(document.querySelector(".action-buttons"), "top-right");
            view.ui.add(legend, "bottom-left");
            view.ui.add(new Compass({view: view}), "top-left");
            view.ui.add(new ScaleBar({view: view}), "bottom-right");
            view.ui.add(new Locate({view: view}), "top-left");
        });
    </script>
</body>
</html>
